name: Code Scanning (Semgrep)
description: "Runs a Semgrep scan on a repository and uploads the results to GitHub"

inputs:
  defectdojo_token:
    description: "Token to use to submit data to DefectDojo"
    required: true
  defectdojo_host:
    description: "Hostname of DefectDojo"
    required: true
  paths_ignored:
    description: "List of paths or patterns to ignore"
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Generate .semgrepignore
      run: |
        echo "${{ inputs.paths_ignored }}" > .semgrepignore
        cat .semgrepignore
      shell: bash

    - name: Semgrep
      run: |
        semgrep \
          --config p/default \
          --config p/owasp-top-ten \
          --config p/security-audit \
          --config p/ci \
          --config p/csharp \
          --config ${{ github.action_path }}/rules/src \
          --verbose --metrics=off --force-color \
          --json-output semgrep-report.json
      shell: bash
      continue-on-error: true

    - name: Upload to DefectDojo
      shell: bash
      run: |
        curl -sS -X POST \
          -H "Authorization: Token ${{ inputs.defectdojo_token }}" \
          -F "file=@semgrep-report.json" \
          -F "scan_type=Semgrep JSON Report" \
          "https://${{ inputs.defectdojo_host }}/api/v2/import-scan/

